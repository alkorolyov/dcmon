{% extends "base.html" %}

{% block title %}{{ page_title }} - dcmon{% endblock %}

{% block content %}
<div class="dashboard-container">
    
    <!-- Single Row: Stats + Controls -->
    <div class="top-bar">
        <div class="stat-item">
            <span class="stat-label">Total:</span>
            <span class="stat-value">{{ total_clients or 0 }}</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Online:</span>
            <span class="stat-value online">{{ online_clients or 0 }}</span>
        </div>
        <div class="controls">
            <div class="timerange-control">
                <button class="btn" id="timerange-btn">
                    <span>Last 24h</span>
                    <span class="arrow">▼</span>
                </button>
                <div class="dropdown" id="timerange-dropdown">
                    <div class="dropdown-item" data-value="5m">Last 5 minutes</div>
                    <div class="dropdown-item" data-value="15m">Last 15 minutes</div>
                    <div class="dropdown-item" data-value="30m">Last 30 minutes</div>
                    <div class="dropdown-item" data-value="1h">Last 1 hour</div>
                    <div class="dropdown-item" data-value="3h">Last 3 hours</div>
                    <div class="dropdown-item" data-value="6h">Last 6 hours</div>
                    <div class="dropdown-item" data-value="12h">Last 12 hours</div>
                    <div class="dropdown-item active" data-value="24h">Last 24 hours</div>
                    <div class="dropdown-item" data-value="2d">Last 2 days</div>
                    <div class="dropdown-item" data-value="7d">Last 7 days</div>
                    <div class="dropdown-item" data-value="30d">Last 30 days</div>
                    <div class="dropdown-separator"></div>
                    <div class="dropdown-item" data-value="absolute">Custom time range</div>
                </div>
            </div>
            <button class="btn" id="refresh-now">Refresh</button>
            <div class="refresh-control">
                <button class="btn" id="refresh-interval-btn">
                    <span>30s</span>
                    <span class="arrow">▼</span>
                </button>
                <div class="dropdown" id="refresh-dropdown">
                    <div class="dropdown-item" data-value="15">15 seconds</div>
                    <div class="dropdown-item active" data-value="30">30 seconds</div>
                    <div class="dropdown-item" data-value="60">1 minute</div>
                    <div class="dropdown-item" data-value="300">5 minutes</div>
                    <div class="dropdown-item" data-value="custom">Custom interval</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Error Display -->
    {% if error %}
    <div class="error-banner">
        <strong>Dashboard Error:</strong> {{ error }}
    </div>
    {% endif %}
    
    <!-- Critical Metrics Table -->
    <div class="table-section">
        <h3 class="table-title">Critical Metrics</h3>
        <div id="clients-table" 
             hx-get="/dashboard/refresh/clients?token={{ request.query_params.get('token', '') }}" 
             hx-trigger="every 30s"
             hx-target="this">
            {% include "components/clients_table.html" %}
        </div>
    </div>
    
    <!-- Time Series Charts -->
    <div class="charts-section">
        <div class="chart-container">
            <h3 class="table-title">GPU Temperature Trends</h3>
            <div id="gpu-temp-chart" class="chart-wrapper">
                <!-- Chart will be rendered here -->
            </div>
        </div>
    </div>
    
    <!-- Recent Alerts -->
    {% if recent_alerts %}
    <div class="dashboard-section">
        <h2 class="section-title">Recent Alerts</h2>
        <div class="alerts-container">
            {% for alert in recent_alerts %}
            <div class="alert alert-{{ alert.type }}">
                <div class="alert-message">{{ alert.message }}</div>
                <div class="alert-time">{{ alert.timestamp | format_time_ago if alert.timestamp else 'Unknown time' }}</div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
</div>
{% endblock %}

{% block extra_scripts %}
<script src="/static/js/dashboard-controls.js"></script>

<script>
// Initialize GPU temperature chart when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    // Wait for uPlot and TimeSeriesManager to be loaded
    if (typeof uPlot !== 'undefined' && window.timeSeriesManager) {
        initializeGpuTempChart();
    } else {
        // Fallback: wait a bit for scripts to load
        setTimeout(initializeGpuTempChart, 500);
    }
});

function initializeGpuTempChart() {
    if (!window.timeSeriesManager) {
        console.error('TimeSeriesManager not available');
        return;
    }
    
    // Get container width for responsive chart
    const container = document.getElementById('gpu-temp-chart');
    const containerWidth = container ? container.offsetWidth - 24 : 800; // Subtract padding
    
    // Create GPU temperature chart
    window.timeSeriesManager.createChart('gpu-temp-chart', {
        title: 'GPU Temperature Over Time',
        yLabel: 'Temperature',
        unit: '°C',
        width: Math.max(600, Math.min(containerWidth, 1200)), // Responsive width
        height: 300,
        apiEndpoint: '/api/timeseries/gpu_temperature',
        apiParams: {
            hours: 24,         // Last 24 hours
            aggregation: 'max' // Max temperature across all GPUs
        }
    });
    
    console.log('GPU temperature chart initialized');
}

// Dashboard API endpoints inherit authentication automatically
// No token management needed
</script>
{% endblock %}

