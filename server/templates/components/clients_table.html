<!-- Critical Health Table -->
<div class="dashboard-tables-container">
    <div class="metric-table-section">
        <div class="metric-table-container">
            <div class="table-scroll-container">
                <table class="metric-table critical-table">
                    <thead>
                        <tr>
                            <th class="col-status"></th>
                            <th class="col-hostname">Machine</th>
                            <th class="col-cpu-temp">CPU°C</th>
                            <th class="col-cpu-usage">CPU%</th>
                            <th class="col-vrm-temp">VRM°C</th>
                            <th class="col-gpu-temp">GPU°C</th>
                            <th class="col-gpu-power">GPU Power</th>
                            <th class="col-gpu-limit">GPU Limit</th>
                            <th class="col-gpu-fan">GPU Fan%</th>
                            <th class="col-ram">RAM%</th>
                            <th class="col-disk-root">Root%</th>
                            <th class="col-disk-docker">Docker%</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for client in clients %}
                        <tr class="client-row {{ 'online' if client.is_online else 'offline' }}">
                            <td class="col-status">
                                <div class="status-dot {{ 'online' if client.is_online else 'offline' }}"></div>
                            </td>
                            <td class="col-hostname">
                                <div class="hostname-cell">{{ client.hostname }}</div>
                            </td>
                            <td class="col-cpu-temp">
                                {% set value = client.latest_metrics.get('cpu_temp_single') %}
                                {% if value is not none %}
                                    {% set status = get_metric_status('cpu_temp_celsius', value) %}
                                    <div class="metric-cell critical-data {{ status }}">{{ "%.0f" | format(value) }}°</div>
                                {% else %}
                                    <div class="metric-cell critical-data no-data">—</div>
                                {% endif %}
                            </td>
                            <td class="col-cpu-usage">
                                {% set value = client.latest_metrics.get('cpu_usage_percent') %}
                                {% if value is not none %}
                                    {% set status = get_metric_status('cpu_usage_percent', value) %}
                                    <div class="metric-cell critical-data {{ status }}">{{ "%.0f" | format(value) }}%</div>
                                {% else %}
                                    <div class="metric-cell critical-data no-data">—</div>
                                {% endif %}
                            </td>
                            <td class="col-vrm-temp">
                                {% set value = client.latest_metrics.get('vrm_temp_max') %}
                                {% if value is not none %}
                                    {% set status = get_metric_status('cpu_vrm_temp', value) %}
                                    <div class="metric-cell critical-data {{ status }}">{{ "%.0f" | format(value) }}°</div>
                                {% else %}
                                    <div class="metric-cell critical-data no-data">—</div>
                                {% endif %}
                            </td>
                            <td class="col-gpu-temp">
                                {% set value = client.latest_metrics.get('gpu_temp_max') %}
                                {% if value is not none %}
                                    {% set status = get_metric_status('gpu_temperature', value) %}
                                    <div class="metric-cell critical-data {{ status }}">{{ "%.0f" | format(value) }}°</div>
                                {% else %}
                                    <div class="metric-cell critical-data no-data">—</div>
                                {% endif %}
                            </td>
                            <td class="col-gpu-power">
                                {% set value = client.latest_metrics.get('gpu_power_max') %}
                                {% if value is not none %}
                                    {% set status = get_metric_status('gpu_power_draw', value) %}
                                    <div class="metric-cell critical-data {{ status }}">{{ "%.0f" | format(value) }}W</div>
                                {% else %}
                                    <div class="metric-cell critical-data no-data">—</div>
                                {% endif %}
                            </td>
                            <td class="col-gpu-limit">
                                {% set value = client.latest_metrics.get('gpu_limit_max') %}
                                {% if value is not none %}
                                    <div class="metric-cell critical-data neutral">{{ "%.0f" | format(value) }}W</div>
                                {% else %}
                                    <div class="metric-cell critical-data no-data">—</div>
                                {% endif %}
                            </td>
                            <td class="col-gpu-fan">
                                {% set value = client.latest_metrics.get('gpu_fan_max') %}
                                {% if value is not none %}
                                    {% set status = get_metric_status('gpu_fan_speed', value) %}
                                    <div class="metric-cell critical-data {{ status }}">{{ "%.0f" | format(value) }}%</div>
                                {% else %}
                                    <div class="metric-cell critical-data no-data">—</div>
                                {% endif %}
                            </td>
                            <td class="col-ram">
                                {% set value = client.latest_metrics.get('memory_usage_percent') %}
                                {% if value is not none %}
                                    {% set status = get_metric_status('memory_usage_percent', value) %}
                                    <div class="metric-cell critical-data {{ status }}">{{ "%.0f" | format(value) }}%</div>
                                {% else %}
                                    <div class="metric-cell critical-data no-data">—</div>
                                {% endif %}
                            </td>
                            <td class="col-disk-root">
                                {% set value = client.latest_metrics.get('disk_root_percent') %}
                                {% if value is not none %}
                                    {% set status = get_metric_status('disk_usage_percent', value) %}
                                    <div class="metric-cell critical-data {{ status }}">{{ "%.0f" | format(value) }}%</div>
                                {% else %}
                                    <div class="metric-cell critical-data no-data">—</div>
                                {% endif %}
                            </td>
                            <td class="col-disk-docker">
                                {% set value = client.latest_metrics.get('disk_docker_percent') %}
                                {% if value is not none %}
                                    {% set status = get_metric_status('disk_usage_percent', value) %}
                                    <div class="metric-cell critical-data {{ status }}">{{ "%.0f" | format(value) }}%</div>
                                {% else %}
                                    <div class="metric-cell critical-data no-data">—</div>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Auto-refresh functionality -->
<script>
document.addEventListener('htmx:afterRequest', function(event) {
    if (event.detail.successful) {
        const now = new Date();
        const timeString = now.toLocaleTimeString();
        // Update any timestamp elements
        document.querySelectorAll('.timestamp').forEach(el => {
            el.textContent = timeString;
        });
    }
});
</script>